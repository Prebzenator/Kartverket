@model WebApplication1.Models.ObstacleData
@{
    ViewData["Title"] = "Register Obstacle";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card shadow-sm rounded-4">
                <div class="card-body p-4">
                    <h1 class="h3 mb-2">Obstacle Registration</h1>
                    <p class="text-muted mb-4">Click the map to choose a location.</p>

                    <form asp-controller="Obstacle" asp-action="DataForm" method="post">
                        @Html.AntiForgeryToken()

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="mb-3">
                            <label asp-for="ObstacleName" class="form-label"></label>
                            <input asp-for="ObstacleName" class="form-control" placeholder="e.g., Fallen tree" />
                            <span asp-validation-for="ObstacleName" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ObstacleHeight" class="form-label"></label>
                            <input asp-for="ObstacleHeight" class="form-control" type="number" step="0.01" min="0" placeholder="e.g., 1,25" />
                            <span asp-validation-for="ObstacleHeight" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ObstacleDescription" class="form-label"></label>
                            <textarea asp-for="ObstacleDescription" class="form-control" rows="3" placeholder="Brief description..."></textarea>
                            <span asp-validation-for="ObstacleDescription" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <div id="map" style="height: 320px; border-radius: 0.75rem;"></div>
                            <small class="text-muted d-block mt-1">
                                Click on the map to set location. Tiles © OpenStreetMap contributors.
                            </small>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col">
                                <label asp-for="Latitude" class="form-label"></label>
                                <input asp-for="Latitude" class="form-control" readonly />
                                <span asp-validation-for="Latitude" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="Longitude" class="form-label"></label>
                                <input asp-for="Longitude" class="form-control" readonly />
                                <span asp-validation-for="Longitude" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="IsDraft" value="false" class="btn btn-primary btn-lg">Submit</button>
                            <button type="submit" name="IsDraft" value="true" formnovalidate class="btn btn-outline-warning">Submit as Draft</button>

                            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Back to Home</a>
                        </div>
                    </form>
                </div>
            </div>
            <p class="text-center text-muted mt-3 small">Map click sets coordinates. You can adjust by clicking again.</p>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const defaultCenter = [59.9139, 10.7522];
        const map = L.map('map').setView(defaultCenter, 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        let marker;
        const fmt = new Intl.NumberFormat(navigator.language || 'nb-NO', { maximumFractionDigits: 6 });
        const latInput = document.getElementById('Latitude');
        const lngInput = document.getElementById('Longitude');

        (function initFromInputs() {
            const lat = latInput?.value?.replace(',', '.');
            const lng = lngInput?.value?.replace(',', '.');
            if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
                const p = [parseFloat(lat), parseFloat(lng)];
                marker = L.marker(p).addTo(map);
                map.setView(p, 14);
            }
        })();

        function setPoint(latlng) {
            if (marker) {
                marker.setLatLng(latlng);
            } else {
                marker = L.marker(latlng).addTo(map);
            }
            latInput.value = fmt.format(latlng.lat);
            lngInput.value = fmt.format(latlng.lng);
        }

        map.on('click', (e) => setPoint(e.latlng));


    </script>
}
