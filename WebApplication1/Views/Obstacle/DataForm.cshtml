@model WebApplication1.Models.ObstacleData
@using WebApplication1.Helpers

@{
    ViewData["Title"] = "Register Obstacle";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <div class="card shadow-sm rounded-4">
                <div class="card-body p-4">
                    <h1 class="h3 mb-2">Obstacle Registration</h1>
                    <p class="text-muted mb-4">Click the map to choose a location or use the tools.</p>

                    <form asp-controller="Obstacle" asp-action="DataForm" method="post" novalidate>
                        @Html.AntiForgeryToken()
                        @if (Model != null && Model.Id > 0)
                        {
                            <input type="hidden" name="id" value="@Model.Id" />
                        }

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <div class="mb-3">
                            <label asp-for="ObstacleName" class="form-label"></label>
                            <input asp-for="ObstacleName" class="form-control" id="ObstacleNameInput" placeholder="e.g., Fallen tree" />
                            <span asp-validation-for="ObstacleName" class="text-danger"></span>
                            @if ((ViewBag.Missing as bool?) ?? false)
                            {
                                <div class="form-text text-warning">
                                    You are reporting a missing obstacle. The name must begin with "MISSING - ".
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label asp-for="CategoryId" class="form-label"></label>
                            <select asp-for="CategoryId" asp-items="ViewBag.CategoryOptions" class="form-select">
                                <option value="">-- Select Category --</option>
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>

                        <!-- HEIGHT INPUT: show feet for Pilot, meters for others -->
                        <div class="mb-3">
                            <label class="form-label">Height (@(User.IsInRole("Pilot") ? "ft" : "m"))</label>

                            <input name="HeightInputRaw" class="form-control"
                                   value="@(User.IsInRole("Pilot")
                                             ? (Model?.ObstacleHeight.HasValue == true
                                                    ? Math.Round(UnitConverter.ToFeet(Model!.ObstacleHeight).GetValueOrDefault(), 0).ToString("F0")
                                                    : string.Empty)
                                             : (Model?.ObstacleHeight.HasValue == true
                                                    ? Model!.ObstacleHeight.GetValueOrDefault().ToString("F2")
                                                    : string.Empty))"
                                   placeholder="e.g., @(User.IsInRole("Pilot") ? "100" : "1.25")" />

                            <div class="form-text">
                                @(User.IsInRole("Pilot")
                                    ? "Enter height in feet; it will be stored as meters."
                                    : "Enter height in meters.")
                            </div>
                            <span asp-validation-for="ObstacleHeight" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="ObstacleDescription" class="form-label"></label>
                            <textarea asp-for="ObstacleDescription" class="form-control" rows="3" placeholder="Brief description..."></textarea>
                            <span asp-validation-for="ObstacleDescription" class="text-danger"></span>
                        </div>

                        <!-- Controls + Map -->
                        <div class="mb-2 d-flex flex-wrap gap-2">
                            <button type="button" id="btn-locate" class="btn btn-primary btn-sm">Finn min posisjon</button>
                            <button type="button" id="btn-drop-pin" class="btn btn-outline-primary btn-sm">Legg nål på posisjonen min</button>
                            <button type="button" id="btn-clear" class="btn btn-outline-danger btn-sm">Tøm tegninger</button>
                        </div>

                        <div class="mb-3">
                            <div id="map" style="height:60vh;min-height:420px;border-radius:.75rem;"></div>
                            <small class="text-muted d-block mt-1">
                                Use the tools on the left to draw (polygon, line, rectangle, circle, marker). Tiles © OpenStreetMap contributors.
                            </small>
                        </div>

                        <!-- Hidden field for drawn geometry -->
                        <input type="hidden" id="GeometryJson" name="GeometryJson" />

                        <div class="row g-3 mb-4">
                            <div class="col">
                                <label asp-for="Latitude" class="form-label"></label>
                                <input asp-for="Latitude" class="form-control" readonly type="text" />
                                <span asp-validation-for="Latitude" class="text-danger"></span>
                            </div>
                            <div class="col">
                                <label asp-for="Longitude" class="form-label"></label>
                                <input asp-for="Longitude" class="form-control" readonly type="text" />
                                <span asp-validation-for="Longitude" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" name="IsDraft" value="false" class="btn btn-primary btn-lg">Submit</button>
                            <button type="submit" name="IsDraft" value="true" formnovalidate class="btn btn-outline-warning">Submit as Draft</button>
                            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">Back to Home</a>
                        </div>
                    </form>
                </div>
            </div>
            <p class="text-center text-muted mt-3 small">Click the map to set coordinates, or use the tools. You can adjust by clicking again.</p>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        (function () {
          // --- Map ---
          const map = L.map('map', { zoomControl: true }).setView([60.472, 8.4689], 5);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);

          // --- Draw layer + toolbar (left) ---
          const drawnItems = new L.FeatureGroup(); map.addLayer(drawnItems);
          if (L.Control && L.Control.Draw) {
            const drawControl = new L.Control.Draw({
              position: 'topleft',
              draw: { polygon:true, polyline:true, rectangle:true, circle:true, marker:true, circlemarker:false },
              edit: { featureGroup: drawnItems, remove:true }
            });
            map.addControl(drawControl);
          }

          // --- Hidden GeoJSON field ---
          const geoInput = document.getElementById('GeometryJson');
          function updateGeoJson(){ geoInput.value = JSON.stringify(drawnItems.toGeoJSON()); }
          map.on(L.Draw ? L.Draw.Event.CREATED : 'noop', e => { drawnItems.addLayer(e.layer); updateGeoJson(); });
          map.on(L.Draw ? L.Draw.Event.EDITED : 'noop', updateGeoJson);
          map.on(L.Draw ? L.Draw.Event.DELETED : 'noop', updateGeoJson);

          // --- Lat/Lng inputs ---
          const latInput = document.getElementById('Latitude');
          const lngInput = document.getElementById('Longitude');
          const fmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 6 });

          // click-to-set point
          let clickMarker = null;
          function setPoint(latlng){
            if (clickMarker) clickMarker.setLatLng(latlng);
            else clickMarker = L.marker(latlng).addTo(map).bindPopup("Valgt posisjon");
            latInput.value = fmt.format(latlng.lat);
            lngInput.value = fmt.format(latlng.lng);
          }
          map.on('click', e => setPoint(e.latlng));

          // --- Geolocation with IP fallback ---
          let lastLocation=null, myMarker=null, accCircle=null;

          function onLocationFound(e){
            lastLocation = e.latlng;

            if (!myMarker) myMarker = L.marker(e.latlng, {title:"Din posisjon"}).addTo(map).bindPopup("Du er her");
            else myMarker.setLatLng(e.latlng);

            if (!accCircle) accCircle = L.circle(e.latlng, {radius: e.accuracy}).addTo(map);
            else accCircle.setLatLng(e.latlng).setRadius(e.accuracy);

            map.flyTo(e.latlng, 15);
            setPoint(e.latlng);
          }

          async function locateByIP(){
            try {
              const r = await fetch('https://ipapi.co/json/');
              const j = await r.json();
              if (j?.latitude && j?.longitude) {
                const ll = L.latLng(parseFloat(j.latitude), parseFloat(j.longitude));
                onLocationFound({ latlng: ll, accuracy: 5000 });
              } else {
                alert("Kunne ikke hente IP-posisjon.");
              }
            } catch { alert("IP-posisjon feilet."); }
          }

          function locateWithFallback(){
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                pos => onLocationFound({
                  latlng: L.latLng(pos.coords.latitude, pos.coords.longitude),
                  accuracy: pos.coords.accuracy
                }),
                _ => locateByIP(),
                { enableHighAccuracy: true, timeout: 7000, maximumAge: 0 }
              );
            } else { locateByIP(); }
          }

          map.on('locationerror', _ => locateByIP());

          document.getElementById('btn-locate').addEventListener('click', locateWithFallback);
          document.getElementById('btn-drop-pin').addEventListener('click', () => {
            if (!lastLocation) { locateWithFallback(); return; }
            drawnItems.addLayer(L.marker(lastLocation).bindPopup("Nål: din posisjon"));
            updateGeoJson();
          });
          document.getElementById('btn-clear').addEventListener('click', () => {
            drawnItems.clearLayers(); updateGeoJson();
          });

          // init from existing inputs if present
          (function initFromInputs(){
            const lat = parseFloat((latInput?.value || '').toString().replace(',', '.'));
            const lng = parseFloat((lngInput?.value || '').toString().replace(',', '.'));
            if (!isNaN(lat) && !isNaN(lng)) {
              const p = L.latLng(lat, lng);
              setPoint(p);
              map.setView(p, 14);
            }
          })();
        })();
    </script>

    @if ((ViewBag.Missing as bool?) ?? false)
    {
        <script>
            const input = document.getElementById("ObstacleNameInput");
            const prefix = "MISSING - ";
            input.addEventListener("keydown", (e) => {
                const c = input.selectionStart;
                if ((e.key === "Backspace" && c <= prefix.length) ||
                    (e.key === "Delete" && c < prefix.length)) e.preventDefault();
            });
            input.addEventListener("input", () => {
                if (!input.value.startsWith(prefix)) {
                    const suffix = input.value.replace(prefix, "");
                    input.value = prefix + suffix;
                    input.setSelectionRange(prefix.length, prefix.length);
                }
            });
            input.addEventListener("focus", () => {
                if (input.selectionStart < prefix.length) {
                    input.setSelectionRange(prefix.length, prefix.length);
                }
            });
        </script>
    }
}
